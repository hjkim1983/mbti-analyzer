# 🤖 MBTI 분석 웹앱 개발 및 분석 지침 (최종 통합본)

## 1. 개발자 페르소나 및 기술 스택
* **역할**: 당신은 전문 웹 개발자이며, `kakao-mbti-scanner.jsx` 코드를 기반으로 안정적이고 세련된 유료 서비스를 구축합니다.
* **기술 스택**: Next.js (App Router), Tailwind CSS, Supabase를 기본으로 사용합니다.
* **보안**: 사용자가 업로드한 이미지는 절대 서버에 저장하지 않습니다. 분석을 위해 **Base64** 형태로 변환하여 AI API 호출에 즉시 사용하고 폐기하는 보안 로직을 구현합니다.
* **확장성**: 향후 **사주(Saju)** 기능을 추가할 예정이므로, Supabase의 `profiles` 테이블에 `birth_date`, `birth_time` 컬럼을 미리 포함하여 모듈화된 DB 구조를 설계합니다.

## 2. 핵심 서비스 워크플로우 (Workflow)
모든 개발은 아래의 사용자 여정을 순차적으로 따르도록 구현합니다:
1.  **데이터 입력**: 사용자가 카톡 캡처 업로드, 분석 대상 이름 입력, 추가 성격 특징을 작성합니다.
2. **무료 횟수 조회 (Supabase)**: 분석 버튼 클릭 시, DB에서 해당 사용자의 누적 분석 횟수를 조회합니다.
3. **분기 처리 (Free vs Paid)**:
   - **Case A (누적 3회 이하)**: 결제창 없이 즉시 4단계(AI 분석)로 진행합니다.
   - **Case B (누적 4회 이상)**: "무료 횟수 소진" 알림과 함께 포트원 결제창을 실행하며, 결제 성공(`paid`) 시에만 4단계로 진행합니다.
4.  **결제 요청**: 사용자가 '분석 요청' 버튼을 누르면 포트원(테스트 모드) 결제창을 실행합니다.
5.  **결제 검증**: 결제 성공(`paid`) 신호를 수신하면 즉시 DB에 기록하고 다음 단계로 진행합니다.
6.  **AI 정밀 분석**: `mbti_skills.md` 기준에 따라 Gemini API를 호출하여 분석 결과를 생성합니다.
7.  **결과 출력**: `loadingSteps` 애니메이션이 종료된 후 최종 분석 보고서를 화면에 렌더링합니다.





## 2. 분석 에이전트 지침 (Core Analysis Logic)
당신은 세 가지 입력 데이터를 통합 분석하여 MBTI를 추론하는 전문 심리언어학 분석 에이전트입니다. 

### **기본 원칙**
* 모든 분석 로직은 프로젝트 루트의 **`mbti_skills.md` 가이드라인을 엄격히 준수**합니다.
* **통합 이미지 처리**: 사용자는 대화 캡처([A])와 프로필 사진([B])을 구분 없이 업로드하므로, AI는 멀티모달 기능을 활용해 이미지 리스트에서 대화 내용과 프로필 정보를 스스로 분류하여 분석 로직을 적용합니다.
* 리액트 코드(`kakao-mbti-scanner.jsx`) 내의 가짜 랜덤 결과 로직을 제거하고, `mbti_skills.md`의 분석 기준을 실제 AI(Gemini/Claude) 프롬프트로 주입하여 결과를 도출합니다.
* 채팅으로 전달된 최신 지침과 `mbti_skills.md`는 기존 설계도보다 항상 **최우선 순위(Override)**를 갖습니다.

### **입력 소스 및 가중치 정의**
* **[A] 카카오톡 대화 스크린샷 (50%)**: 사용자가 입력한 '이름/대화명'(`targetName`)을 기반으로 해당 인물의 발언만 추출하여 분석합니다.
* **[B] 프로필 사진 (15%)**: 의도적 자기 표현 및 시각적 자아 이미지를 분석합니다.
* **[C] 행동/성격 텍스트 (35%)**: 사용자가 선택한 태그나 직접 입력한 메모(`memo`)로, 분석 시 **가장 강력한 가중치**를 부여합니다.

### **입력 누락 시 가중치 재조정**
* **[A]만 존재**: A=80%, B=20% / **[A]+[B]**: A=65%, B=35% / **[A]+[C]**: A=60%, C=40% / **[C]만 존재**: C=100% (신뢰도 LOW 고정)

## 3. 핵심 기능 구현 세부 지침
* **대상 식별 (이름 매칭)**: `targetName`에 입력된 텍스트와 이미지 내 대화명을 대조하여 특정 인물의 대화 내용만 선별적으로 분석합니다.
* **지표 산정**: 각 MBTI 지표(E/I, S/N, T/F, J/P)에 대해 `mbti_skills.md` 체크리스트 기준 0~100점을 산출하고, 최종 유형과 확신도를 출력합니다.
* **유료 결제 연동**: **포트원(토스페이먼츠) 테스트 모드**를 연동합니다. '분석 요청' 버튼 클릭 시 결제창을 먼저 띄우고, 결제 상태가 **'성공(paid)'**인 경우에만 AI 분석 로직을 호출하고 결과를 DB에 저장합니다.

## 4. Git 자동 커밋 규칙
* 코드 변경 작업이 완료되면 반드시 `git add .` 후 한글 커밋 메시지로 자동 커밋한다.
* 커밋 메시지 형식: 변경 내용을 간결하게 한글로 요약 (예: "배경색 노란색으로 변경", "헤더 텍스트 추가")
* `.env` 파일은 절대 커밋하지 않는다 (`.gitignore` 확인).
* 여러 파일을 동시에 수정한 경우, 하나의 커밋으로 묶어서 전체 변경 내용을 요약한다.

## 5. UI/UX 디자인 가이드
* **디자인 기반**: 제공된 `kakao-mbti-scanner.jsx`의 레이아웃, 애니메이션(pulse-ring, float 등), 로딩 스텝 로직을 그대로 유지합니다.
* **로딩 경험**: `loadingMsgs`와 `loadingSteps`를 활용하여 AI가 실제로 정밀 분석을 수행하고 있다는 '진행감'을 사용자에게 확실히 전달합니다.


